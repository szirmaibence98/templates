name: Package and Push Helm Chart to ACR


on:
  workflow_call:
    inputs:
      release:
        description: 'Skip workflow if set to true for releases'
        required: false
        type: boolean  
    secrets:
      ACR_USERNAME:
        required: true
      ACR_PASSWORD:
        required: true

jobs:
  package-and-push:
    if: ${{ inputs.release == false }} 
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download version file
        uses: actions/download-artifact@v4.1.4
        with:
          name: version
          path: /tmp

      - name: Set chartVersion and appVersion
        id: set_versions
        run: |
          ORIGINAL_VERSION=$(cat /tmp/version.txt)
          # Set appVersion to the original version always
          echo "appVersion=$ORIGINAL_VERSION" >> $GITHUB_ENV
          # Check if the current branch is main
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            # Use the original version for main branch
            echo "chartVersion=$ORIGINAL_VERSION" >> $GITHUB_ENV
          else
            # For feature branches, use version 0.0.1 for chartVersion
            echo "chartVersion=0.0.1" >> $GITHUB_ENV
          fi
          
      - name: Helm tool installer
        uses: Azure/setup-helm@v4
        with:
          version: latest

      - name: Log in to Azure Container Registry
        run: echo "${{ secrets.ACR_PASSWORD }}" | helm registry login szirmaibence98.azurecr.io --username ${{ secrets.ACR_USERNAME }} --password-stdin
        
      - name: Package Helm chart
        run: helm package charts/mychart -d .deploy --version ${{ env.chartVersion }} --app-version ${{ env.appVersion }}

  
      - name: Push Helm chart to ACR
        run: |
          CHART_VERSION=${{ env.chartVersion }}
          echo "Using chart version: $CHART_VERSION"
          helm push .deploy/mychart-${CHART_VERSION}.tgz oci://szirmaibence98.azurecr.io/mychart
